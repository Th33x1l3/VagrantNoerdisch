#####
## THIS FILE IS MANAGED BY PUPPET
##
## DO NOT TOUCH!
#####

server {
    listen 80 default_server;
    listen 443 ssl http2 default_server;

    server_name
        "~(?<eengine>(php55|php56|php70|php71)?)((?<dot>\.)?((?<domhost>((.+\.)?(([a-z0-9]+(-[a-z0-9]{1,64})*\.)?)+[a-z]{2,6})))?(?<dot1>\.))?(?<project>.*)\.(?<environment>(<%= @environment %>|<%= @hostname %>))\.noerdisch\.net$";

    access_log /var/log/nginx/access.$project.log;

    set $docroot_part "Web";
    if ( -d /var/www/$project/html) {
        set $docroot_part "html";
    }

    root /var/www/$project/$docroot_part;

    index index.php index.html;

    set $pinned false;
    if ( -f /var/www/$project/.php55 ) {
        set $engine php55_fpm;
        set $pinned php55;
    }

    if ( -f /var/www/$project/.php56 ) {
        set $engine php56_fpm;
        set $pinned php56;
    }

    if ( -f /var/www/$project/.php70 ) {
        set $engine php70_fpm;
        set $pinned php70;
    }

    if ( -f /var/www/$project/.php71 ) {
        set $engine php71_fpm;
        set $pinned php71;
    }

    location @catchInstallTool {
        add_header "X-Status-Cause" "config";
        return 302 /typo3/sysext/install/Start/Install.php;
    }

    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }

    location = /favicon.ico {
        try_files $uri =204;
    }

    location ~* (^|/)\. {
        add_header "X-Status-Cause" "config";
        return 403;
    }

    location ~* (\.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)|~)$ {
        add_header "X-Status-Cause" "config";
        return 403;
    }

    location /typo3/install/ {
        try_files $uri $uri/ @catchInstallTool;
    }

    location ~ "^/_Resources/Persistent/" {
        rewrite "(.{40})/.+\.(.+)" /_Resources/Persistent/$1.$2 break;
        rewrite "([a-z0-9]+/(.+/)?[a-f0-9]{40})/.+\.(.+)" /_Resources/Persistent/$1.$2 break;
    }

    add_header "X-Noerd-Project" $project;
    add_header "X-Noerd-DomHost" $domhost;
    add_header "X-Noerd-Expected-Engine" $eengine;
    add_header "X-Noerd-Evaluated-Engine" $engine;
    add_header "X-Noerd-Pinned-Engine" $pinned;

    location ~ \.php$ {
        try_files $uri /index.php$is_args$args;

        fastcgi_split_path_info ^(.+\.php)(.*)$;

        include conf.d/fastcgi.conf;
        include conf.d/fastcgi_params;

        fastcgi_param PATH_INFO $fastcgi_path_info;

        fastcgi_pass $engine;
    }
}
